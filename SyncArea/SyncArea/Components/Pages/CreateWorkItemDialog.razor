@using MudBlazor
@using SyncArea.Pages.Account
@using SyncArea.Services
@using SyncArea.Identity.Models
@using System.Text.Json
@inject WorkItemService WorkItemService
@inject UserManager<ApplicationUser> UserManager
@inject ISnackbar Snackbar
@inject UserCRUDService UserCRUDService
@inject IJSRuntime JSRuntime
@inherits MudComponentBase

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">添加工作项</MudText>
    </TitleContent>
    <DialogContent>
        <EditForm Model="@Model" OnValidSubmit="HandleCreateWorkItem">
            <DataAnnotationsValidator />
            <MudTextField Variant="Variant.Outlined" Label="备注（可选）" @bind-Value="Model.Remark" />
            <MudTextField Variant="Variant.Outlined" Format="yyyy-MM-dd" Label="日期" InputType="InputType.Date" @bind-Value="Model.Date" Required="true" />
            <input type="file" multiple accept="image/*"  id="fileInput" style="margin-top: 8px;" />
            <MudText Typo="Typo.body2" Class="mt-2" Id="imageCount">已选择 0 张图片</MudText>
            <div id="imagePreviewContainer" class="mt-2" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-2">@ErrorMessage</MudAlert>
            }
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Outlined" OnClick="Cancel">取消</MudButton>
        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Outlined" Color="Color.Primary" OnClick="HandleCreateWorkItem">创建</MudButton>
    </DialogActions>
</MudDialog>

<style>
    .gallery-card {
    transition: transform 0.2s;
    position: relative;
    width: 100px;
    height: 100px;
    }

    .gallery-card:hover {
    transform: scale(1.05);
    }

    .delete-button {
    position: absolute;
    top: -8px;
    right: -8px;
    background: red;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    }
</style>

@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public Guid WorkspaceId { get; set; }
    [Parameter] public EventCallback<WorkItemDto> OnWorkItemCreated { get; set; }

    private CreateWorkItemModel Model { get; set; } = new();
    private string ErrorMessage { get; set; } = string.Empty;

    public class CreateWorkItemModel
    {
        public string? Remark { get; set; }
        public DateTime Date { get; set; } = DateTime.Now; // 默认值为当前时间
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("initializeFileInput", "fileInput", "imagePreviewContainer", "imageCount");
        }
    }

    private async Task HandleCreateWorkItem()
    {
        var user = UserCRUDService.CurrentUser;
        if (user == null || string.IsNullOrEmpty(user.Id))
        {
            ErrorMessage = "用户未登录或 UserId 无效";
            Snackbar.Add(ErrorMessage, Severity.Error);
            return;
        }

        // 验证 WorkspaceId
        if (WorkspaceId == Guid.Empty)
        {
            ErrorMessage = "工作区 ID 无效";
            Snackbar.Add(ErrorMessage, Severity.Error);
            return;
        }

        // 验证 Date
        if (Model.Date == default)
        {
            ErrorMessage = "日期不能为空";
            Snackbar.Add(ErrorMessage, Severity.Error);
            return;
        }

        try
        {
            var formData = new
            {
                UserId = user.Id,
                WorkspaceId = WorkspaceId.ToString(),
                Remark = Model.Remark ?? "",
                Date = Model.Date.ToString("o") // ISO 8601 格式
            };


            var result = await JSRuntime.InvokeAsync<UploadResult>("uploadWorkItem","/api/workitems", formData);
            if (result.Success)
            {
                //var workItem = JsonSerializer.Deserialize<WorkItemDto>(JsonSerializer.SerializeToDocument(result.Data));
                if (result.Data!= null)
                {
                    Snackbar.Add("工作项创建成功", Severity.Success);
                    await OnWorkItemCreated.InvokeAsync(result.Data);
                    MudDialog.Close(DialogResult.Ok(true));
                }
                else
                {
                    ErrorMessage = "创建工作项失败：返回数据无效";
                    Snackbar.Add(ErrorMessage, Severity.Error); 
                }
            }
            else
            {
                // 解析详细的验证错误
                try
                {
                    var errorResponse = System.Text.Json.JsonSerializer.Deserialize<ValidationErrorResponse>(result.Error);
                    var errors = errorResponse?.Errors?.Select(e => $"{e.Key}: {string.Join(", ", e.Value)}") ?? new[] { result.Error };
                    ErrorMessage = $"创建工作项失败: {string.Join("; ", errors)}";
                }
                catch
                {
                    ErrorMessage = $"创建工作项失败: {result.Error}";
                }
                Snackbar.Add(ErrorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"创建工作项失败: {ex.Message}";
            Snackbar.Add(ErrorMessage, Severity.Error);
        }
    }

    private async Task Cancel()
    {
        await JSRuntime.InvokeVoidAsync("clearFiles");
        MudDialog.Cancel();
    }

    private class UploadResult
    {
        public bool Success { get; set; }
        public WorkItemDto? Data { get; set; } 
        public string Error { get; set; } = string.Empty;
    }

    private class ValidationErrorResponse
    {
        public string Type { get; set; }
        public string Title { get; set; }
        public int Status { get; set; }
        public Dictionary<string, string[]> Errors { get; set; }
        public string TraceId { get; set; }
    }
}